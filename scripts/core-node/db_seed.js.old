#!/usr/bin/env node
/**
 * db_seed.js ‚Äî Seed database with data
 * Usage: 
 *   node scripts/db_seed.js              # Add basic reference data only
 *   node scripts/db_seed.js --mockup     # Add fake data for testing
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// Cross-platform command execution
function execCommand(command, options = {}) {
  try {
    return execSync(command, { 
      stdio: 'inherit', 
      encoding: 'utf8',
      ...options 
    });
  } catch (error) {
    if (options.allowFailure) {
      return null;
    }
    throw error;
  }
}

// Check if command exists
function commandExists(command) {
  try {
    execSync(command, { stdio: 'ignore' });
    return true;
  } catch {
    return false;
  }
}

// Execute SQL file
function executeSqlFile(filePath) {
  const DATABASE_URL = process.env.DATABASE_URL || 'postgresql://postgres:postgres@127.0.0.1:54322/postgres';
  
  if (!fs.existsSync(filePath)) {
    throw new Error(`SQL file not found: ${filePath}`);
  }
  
  console.log(`   -> Executing: ${path.basename(filePath)}`);
  
  try {
    const env = { ...process.env };
    env.PGPASSWORD = env.PGPASSWORD || 'postgres';
    
    execSync(`psql "${DATABASE_URL}" -v ON_ERROR_STOP=1 -f "${filePath}"`, {
      stdio: 'pipe',
      env
    });
    
    console.log(`   ‚úÖ ${path.basename(filePath)} executed successfully`);
  } catch (error) {
    console.log(`   ‚ùå Error executing ${path.basename(filePath)}:`, error.message);
    throw error;
  }
}

// Check if database is initialized
function checkDatabaseInitialized() {
  const DATABASE_URL = process.env.DATABASE_URL || 'postgresql://postgres:postgres@127.0.0.1:54322/postgres';
  
  try {
    const result = execSync(`psql "${DATABASE_URL}" -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users';"`, {
      stdio: 'pipe',
      encoding: 'utf8'
    });
    
    const count = parseInt(result.trim());
    return count > 0;
  } catch (error) {
    return false;
  }
}

// Main function
async function main() {
  console.log('==> GMBS CRM Database Seeding');
  console.log('==============================');
  
  // Parse command line arguments
  const args = process.argv.slice(2);
  const useMockup = args.includes('--mockup');
  
  if (useMockup) {
    console.log('üìä Mode: Mockup data (fake data for testing)');
  } else {
    console.log('üìã Mode: Basic data (reference data only)');
  }
  
  // Check if psql is available
  if (!commandExists('psql')) {
    console.error('‚ùå psql is not available.');
    console.error('Please install PostgreSQL client or ensure it is in your PATH.');
    process.exit(1);
  }
  
  // Check if Supabase CLI is available and start it
  if (commandExists('supabase') && fs.existsSync(path.join(__dirname, '..', 'supabase'))) {
    console.log('==> Starting local Supabase (if not already running)');
    execCommand('supabase start', { allowFailure: true });
  }
  
  try {
    // Check if database is initialized
    console.log('==> Checking database initialization...');
    const isInitialized = checkDatabaseInitialized();
    
    if (!isInitialized) {
      console.error('‚ùå Database is not initialized!');
      console.error('Please run "node scripts/db_init.js" first to initialize the database.');
      process.exit(1);
    }
    
    console.log('‚úÖ Database is initialized, proceeding with seeding');
    
    const ROOT_DIR = path.resolve(__dirname, '..');
    
    if (useMockup) {
      // Use mockup data
      console.log('==> Seeding database with mockup data...');
      const mockupFile = path.join(ROOT_DIR, 'supabase', 'seed_mockup.sql');
      executeSqlFile(mockupFile);
      
      console.log('');
      console.log('‚úÖ Mockup data seeding completed successfully!');
      console.log('');
      console.log('The database now contains:');
      console.log('‚Ä¢ 5 test users (admin, manager, 3 gestionnaires)');
      console.log('‚Ä¢ 10 fake clients');
      console.log('‚Ä¢ 10 fake artisans with different m√©tiers');
      console.log('‚Ä¢ 10 fake interventions with various statuses');
      console.log('‚Ä¢ Tasks, comments, and billing data');
      console.log('‚Ä¢ Artisan absences and usage events');
      console.log('');
      console.log('You can now test the application with realistic data.');
      
    } else {
      // Use basic seed data (already included in migration file)
      console.log('==> Database already contains basic reference data');
      console.log('');
      console.log('‚úÖ Basic seeding completed!');
      console.log('');
      console.log('The database contains:');
      console.log('‚Ä¢ Default roles (admin, manager, gestionnaire)');
      console.log('‚Ä¢ Default permissions');
      console.log('‚Ä¢ Reference data (m√©tiers, zones, agencies)');
      console.log('‚Ä¢ Default statuses for artisans, interventions, and tasks');
      console.log('');
      console.log('To add fake data for testing, run:');
      console.log('node scripts/db_seed.js --mockup');
    }
    
  } catch (error) {
    console.error('‚ùå Database seeding failed:', error.message);
    process.exit(1);
  }
}

// Run main function
main().catch(console.error);
